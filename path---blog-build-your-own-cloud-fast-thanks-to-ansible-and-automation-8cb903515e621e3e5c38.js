webpackJsonp([0xdbb8f5499cd6],{506:function(e,a){e.exports={data:{allShareJson:{edges:[{node:{id:"2f0a723b-2772-40bf-9edc-70dd70337f10",slug:"facebook",name:"Facebook",url:"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup",width:626,height:457}},{node:{id:"f5678f7f-ae05-444a-af1a-1167a30d0cce",slug:"linkedin",name:"LinkedIn",url:"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=",width:600,height:450}},{node:{id:"4cbf0a18-d389-4583-98ac-501e59f1be18",slug:"twitter",name:"Twitter",url:"https://twitter.com/share?url=%POSTURL%&amp;text=",width:500,height:550}}]},markdownRemark:{html:'<p>Last year I wrote an <a href="/blog/installing-custom-linux-on-raspberry-pi-2">article about installing custom linux distro on Raspberry Pi 2</a>.\nSince then I configured it as my personal cloud, with <a href="https://bit.ly/2LGNWiS">email daemon</a>,\n<a href="https://owncloud.org/">dropbox alternative</a>, <a href="https://roundcube.net/">webmail</a>,\n<a href="https://bit.ly/2qrPX8W">backup system</a> and some other tools. However it appeared, that\nconfiguration like that is a real SDCard killer (tons of small files), and in a past year\nI had to replace it twice, each time redoing the whole configure &#x26; install again.</p>\n<p>This was always a real time consuming <a href="https://www.netlingo.com/word/pita.php">PITA</a>, so\nI decided to automate the whole process, thus the <a href="https://github.com/ajgon/self-hosted-mailserver">self-hosted-mailserver</a>\nproject was born.</p>\n<p>I wrote it with "Keep it simple and secure" principle in mind. As it will be\nused exclusively by the owner, I assumed he would use most recent versions of\nsoftware and dropped all legacy protocols (like SSL, TLS &#x3C; 1.2 etc.).</p>\n<h2>Preparation</h2>\n<p>First of all, you need ansible.</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">brew <span class="token function">install</span> ansible</code></pre>\n      </div>\n<p>Also if you haven\'t done it already, add your public SSH key file to authorized keys\nof the root user on your Raspberry (or any other server) and set <code class="language-text">PermitRootLogin</code>\nto <code class="language-text">true</code> (don\'t worry though, those scripts will take care of this security risk later on\nand disable it).</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token function">export</span> MACHINE_IP<span class="token operator">=</span><span class="token operator">&lt;</span>machine IP<span class="token operator">></span>\n<span class="token function">ssh</span> root@<span class="token variable">${MACHINE_IP}</span> <span class="token string">\'mkdir /root/.ssh &amp;&amp; chmod 700 /root/.ssh &amp;&amp; touch /root/.ssh/authorized_keys &amp;&amp; chmod 600 /root/.ssh/authorized_keys\'</span>\n<span class="token function">scp</span> ~/.ssh/id_rsa.pub root@<span class="token variable">${MACHINE_IP}</span>:/root/.ssh/authorized_keys</code></pre>\n      </div>\n<h3>Setting up GPG</h3>\n<p>If you want to use external backups, you need to install GPG on the server\n(this bases on assumption, to NEVER store any private data remotely without encrypting\nthem first). Also, you need a GPG key (you can skip next step if you have one already).</p>\n<h4>Creating a GPG key</h4>\n<p>Refer to <a href="https://www.gnupg.org/documentation/">GPG documentation</a> for more examples,\nbut in general all you have to do is invoke <code class="language-text">gpg --gen-key</code> and answer its questions. Choose RSA,\n4096 bits size, and never expiring key. Then export it and store it somewhere safe.\nYou will need it in a minute. Also take a note o the Key-Id property.</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">brew <span class="token function">install</span> gpg\ngpg --gen-key\ngpg --export -a -r email@used.to.create.key.com <span class="token operator">></span> raspberry.public\ngpg --export-secret-key -a -r email@used.to.create.key.com <span class="token operator">></span> raspberry.private\ngpg --list-keys <span class="token operator">|</span> <span class="token function">grep</span> -B1 <span class="token string">\'ajgon@irgon.com\'</span> <span class="token operator">|</span> <span class="token function">grep</span> pub <span class="token operator">|</span> <span class="token function">sed</span> <span class="token string">\'s/.*\\/\\(.*\\)\\ .*/\\1/\'</span>\n<span class="token comment"># *The last command returns your Key-Id, note it somewhere as well.</span></code></pre>\n      </div>\n<h2>Configuration</h2>\n<p>To make those scripts work, you need to set some of user-based variables (like passwords, emails etc.).\nThose variables are stored in <code class="language-text">roles/*/vars/main.yml</code> files.</p>\n<h3>roles/base/vars/main.yml</h3>\n<p>This one is pretty straightforward. The cloud uses MySQL as a database of choice, for email configuration,\nweb applications etc. Here you need to set up a mysql <code class="language-text">root</code> user password. If you don\'t plan to ever use it\njust type:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token keyword">echo</span> <span class="token string">"mysql_root_password: \\"<span class="token variable"><span class="token variable">$(</span>pwgen 30 1<span class="token variable">)</span></span>\\""</span> <span class="token operator">></span> roles/base/vars/main.yml</code></pre>\n      </div>\n<h3>roles/duplicity/vars/main.yml</h3>\n<p><a href="https://duplicity.nongnu.org/">Duplicity</a> is a tool for automated backups.\nIt is known that all people can be divided into two groups: those who have never lost important data\nand those who regularly perform data backups. This task, encrypts all the important\ndata (emails, owncloud files etc.) and stores them on WebDav-based remote (personally\nI use <a href="https://box.com">box.com</a>).</p>\n<p>Here (besides the WebDav host, username and password) you need to put the GPG Key-Id which you\nnoted earlier, under the <code class="language-text">encrypt_key</code> property.</p>\n<p>Also, there is a VERY important parameter called <code class="language-text">cache_directory</code>. For Raspberry it is crucial\nto set it to somewhere outside of the microSD card - otherwise you will kill it pretty quick\n(as I did... twice, before noticing this out).</p>\n<p>If you don\'t want to set up the duplicity (or plan to do it later manually), just remove\nthis task from <code class="language-text">main.yml</code> file which lives in root directory of the project.</p>\n<h3>roles/maildb/vars/main.yml</h3>\n<p>First important service of our cloud - the mailserver. Since many things needs to be configured,\nthis file is most complicated. So let\'s go through it line by line.</p>\n<ul>\n<li><code class="language-text">postmaster_email</code> - Basically a local email which will receive all the mailer-daemon failure\nmessages. Don\'t use some bizzare e-mail you never check here, since those messages are pretty\nimportant (your email may never reach the recipient, and you will never notice it if you don\'t\ncheck those warnings)</li>\n<li><code class="language-text">username</code>, <code class="language-text">password</code> and <code class="language-text">database</code> - Since whole accounts setup is stored in RDBMS, you need\nto put its credentials here. Don\'t use the root! You would probably never use this account,\nso it is save, to put some auto-generated random characters password here.</li>\n<li>\n<p><code class="language-text">domains</code> - An array of domains you wish to serve in your server. Each item is a hash, consiting\nfollowing keys:</p>\n<ul>\n<li><code class="language-text">name</code> - the name of the domain (without user), i.e. for <code class="language-text">user@example.com</code> it will be <code class="language-text">example.com</code>.</li>\n<li><code class="language-text">primary</code> - <code class="language-text">yes</code> or <code class="language-text">no</code>. A primary domain (in those scripts context) is a domain you wish to receive\n<a href="https://z-push.org/">Z-Push</a> notifications from. If you configure only one domain (most common case),\nset it to true.</li>\n<li><code class="language-text">users</code> - an array of email/password hashes which will become user accounts. Configure "real" accounts\nhere only. There is a separate section for aliases.</li>\n<li><code class="language-text">email</code> - user email - it\'s domain must match the domain name configured for this group, i.e.\nfor given example, <code class="language-text">user@example.com</code> is valid, while <code class="language-text">user@example2.com</code> is not. If you wish\nto have different domains, configure separate <code class="language-text">domains</code> groups for them.</li>\n<li><code class="language-text">password</code> - a password for user email.</li>\n<li><code class="language-text">aliases</code> - here you can configure aliases of the emails.</li>\n<li><code class="language-text">from</code> - the name of the alias (full email). It must match the <code class="language-text">domains</code> name (like user email).</li>\n<li><code class="language-text">to</code> - destination email. This one can be any valid email (doesn\'t have to match the domain criteria)</li>\n</ul>\n</li>\n</ul>\n<h3>roles/owncloud/vars/main.yml<code class="language-text">and</code>roles/roundcube/vars/main.yml</h3>\n<p>Configuration for both roundcube and owncloud is pretty straightforwrd. Remember, to use separate RDBMS\ncredentials for each one, and use non-admin user with ownCloud.</p>\n<h3>roles/postfix/vars/main.yml</h3>\n<p>Here you can configure <a href="https://en.wikipedia.org/wiki/Open_mail_relay">a relay</a>. This is pretty useful\nif your IP is on some kind of blacklist (which is typical for most Internet providers). Here you can\nset up a non-blacklisted relay server which will process your email and deliver it to the destination.\nThis isn\'t a good option when it comes to privacy, but sometimes - the only one you might have.</p>\n<h3>roles/nginx/vars/main.yml</h3>\n<p>As I mentioned - those scripts are written with security in mind. One of the features is\n<a href="https://en.wikipedia.org/wiki/HTTP_Public_Key_Pinning">HPKP</a> enabled in a webserver - so you need provide\na SHA256 sum here of alternate SSL key (the primary will be calculated for you by the scripts).\nHPKP is pretty broad topic, but you can <a href="https://scotthelme.co.uk/hpkp-http-public-key-pinning/">start here</a>\nif you need more details.</p>\n<h3>roles/security/vars/main.yml</h3>\n<p>A configuration for all security related data. Currently it\'s just username, password and public key for\n"user" account (as you should never login directly via root).</p>\n<p>Also you can set here an email for all security-related reports. This email should live outside of the\nserver (for example on gmail or any other provider). The reason for this is, that when machine gets compromised\nthe local emails may be altered or broken. Of course, nothing prevents an attacker to disable this external\nreporting as well, but at least you have this one extra layer of protection. It is also a good idea to set up\nfiltering rules on this external account, to send those messages back to your usual email. Thanks to that, you\nwill see them without accessing the external, while keeping them backed up there.</p>\n<p>The last setting here is <code class="language-text">strong_primes</code>. If you are setting your server on a strong machine (i.e. powerful\ndedicated server etc.), you can set it to <code class="language-text">true</code> and call it a day (and skip the rest of this paragraph).\nHowever if you use some weak microcomputer (like Pi), it\'s better idea to set it to false and create those\nprimes manually on better machine (like your laptop). Otherwise your ansible deployment can take hours if not days.</p>\n<h4>Creating primes manually</h4>\n<p>First of all, take look on commands you need to invoke:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> roles/*/tasks/main.yml <span class="token operator">|</span> <span class="token function">grep</span> -B1 <span class="token string">\'when: security.strong_primes\'</span> <span class="token operator">|</span> <span class="token function">grep</span> shell</code></pre>\n      </div>\n<p>You need to slightly alter them, as they normally invoked on remote environment, and use filepaths typical for there\n(i.e. <code class="language-text">/etc/ssh</code>). The simplest solution is to rename <code class="language-text">/etc</code> to <code class="language-text">/tmp</code> and fire them up with this context.\nSo for example:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> /tmp/ssh /tmp/ssl\nssh-keygen -G /tmp/ssh/moduli.all -b 4096 <span class="token operator">&amp;&amp;</span> ssh-keygen -T /tmp/ssh/moduli.safe -f /tmp/ssh/moduli.all <span class="token operator">&amp;&amp;</span> <span class="token function">mv</span> /tmp/ssh/moduli.safe /tmp/ssh/moduli <span class="token operator">&amp;&amp;</span> <span class="token function">rm</span> /tmp/ssh/moduli.all\n<span class="token function">rm</span> /tmp/ssh/ssh_host_*key* <span class="token operator">&amp;&amp;</span> ssh-keygen -t ed25519 -f /tmp/ssh/ssh_host_ed25519_key <span class="token operator">&lt;</span> /dev/null <span class="token operator">&amp;&amp;</span> ssh-keygen -t rsa -b 4096 -f /tmp/ssh/ssh_host_rsa_key <span class="token operator">&lt;</span> /dev/null <span class="token operator">&amp;&amp;</span> <span class="token function">chmod</span> 600 /tmp/ssh/ssh_host_*key"\nopenssl dhparam -out /tmp/ssl/dhparams.pem 4096</code></pre>\n      </div>\n<p>After some time, you will end up with <code class="language-text">/tmp/ssh</code> and <code class="language-text">/tmp/ssl</code> directories with proper keys. Just copy\nthem to the corresponding <code class="language-text">/etc</code> directories on the server and you\'re set.</p>\n<h3>SSL keys</h3>\n<p>Since all communication would (and should) be handled via SSL, you need to create proper certificates.\nThe easiest solution are <a href="https://www.akadia.com/services/ssh_test_certificate.html">self signed ones</a>,\nbut I strongly encourage you to use <a href="https://www.startssl.com/">StartSSL</a> or\n<a href="https://letsencrypt.org/">Let\'s Encrypt</a> and issue yourself a valid, properly recognized certificate.</p>\n<p>After you do this, it\'s pretty strightforward - put the private key to <code class="language-text">roles/ssl/templates/private-this-machine.pem</code>\nand the certificate chain to <code class="language-text">roles/ssl/templates/certs-this-machine.pem</code>.</p>\n<h3>roles/ddclient/templates/ddclient.conf.j2</h3>\n<p><a href="https://sourceforge.net/p/ddclient/wiki/Home/">ddclient</a> is a nice Perl script used to update dynamic DNS\nentries for accounts on Dynamic DNS Network Service Provider. Thanks to it, if you have a dynamic IP\nyou can assign a domain to it, and keep it in sync any time when your IP changes. It supports\nmany providers, and I also included a Cloudflare patch. The template itself is pretty explanatory, but you\ncan also refer to the <a href="https://sourceforge.net/p/ddclient/wiki/Home/#configuration">ddclient documentation</a>.\nIf you don\'t want to use this feature (or have a Static IP), just remove <code class="language-text">ddclient</code> from the main <code class="language-text">main.yml</code> file.</p>\n<h2>Deploy</h2>\n<p>Phew! After all this configuration, you are ready to deploy. First, you need to set an\n<a href="https://docs.ansible.com/ansible/intro_inventory.html">Ansible Inventory</a> files. Since we set our public\nkey as authorized on the remote host, all we have to put in this file is:</p>\n<div class="gatsby-highlight" data-language="ini">\n      <pre class="language-ini"><code class="language-ini"><span class="token selector">[local]</span>\n1.2.3.4 ansible_ssh_user<span class="token attr-value"><span class="token punctuation">=</span>root</span></code></pre>\n      </div>\n<p>where <code class="language-text">1.2.3.4</code> is remote IP of your machine obviously. And then, we can fire it up!</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">ansible-playbook -s -i ansible-inventory main.yml</code></pre>\n      </div>\n<p>Hopefully everything go well, and you will end up with your self-hosted, automated cloud.</p>\n<h3>Post-deploy</h3>\n<p>We still have one thing to do - install gpg and import our keys, to make duplicity actually work. So put your\nprivate and public key on the server, and invoke (on remote):</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token function">apt-get</span> <span class="token function">install</span> gnupg\ngpg --import raspberry.public\ngpg --allow-secret-key-import --import raspberry.private\ngpg --list-keys --fingerprint --with-colons <span class="token operator">|</span> <span class="token function">sed</span> -E -n -e <span class="token string">\'s/^fpr:::::::::([0-9A-F]+):$/\\1:6:/p\'</span> <span class="token operator">|</span> gpg --import-ownertrust</code></pre>\n      </div>\n<h2>Conclusion</h2>\n<p>Well, that was a lot of configuration. Thankfully, you have to do this only once. After that, just archive all those files,\nencrypt and store them somewhere safe. If you ever need to redo those steps again, almost everything would be ready and\nprepared, and firing up a new instance will be as simple as typing a few commands.</p>',excerpt:"Last year I wrote an  article about installing custom linux distro on Raspberry Pi 2 .\nSince then I configured it as my personal cloud, with…",frontmatter:{title:"Build Your Own Cloud Fast, Thanks to Ansible and Automation",date:"May 22, 2016",cover:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAACY0lEQVQoz51TW0/UQBjdPwe+6au/wsT4qvHNqDHGF+MtEJREgYCrVMXFhe2FbjvbTmem7fY+nd63rLLwIE+8WBYBL/hicjKZmeSc833fnGnhrPhvtP44oymO92mOigoVo98uLybnVbOSrHCKYzQblJeWH9iej4uKpBlOM3QxmaVmSK28BCxfdYp3bmGkBSkr0h+AbQGmWS8eb9HdQfJT9JyMRrs2AObD+zBJ3gbVle7u1c180/LsqiLQErdF3o6ORmty7nHBZOAMSZzirDx3JkkG+oquwTAM3gj6ox7qGtjIih1RWm+3JSdwPaAHnkQrIMsG19YbSppPndOcVLXS1550wFMlobYLhd6AJvW3vZmZmdlLs+PJRPYop1ucQUw/VAkR3ACXo2airUbDrPeYytX63TvaeBkwLPH9kI729h8/n3+2sHhweIhYFWVQh68/IXfAGNAhHjqkHLWaOeEkNQyUEfw9YzaEy7IuDV3JdzVGkI9FL7TKYiU+eKDlkmGolBGeV7pdWFTHPetxorB0248+G0TE0o6DRUevuduThRu6+x6Ysm25qqJyGpYdj0cExImWZA2r1ZSOq9oeOvbGR8Gjvice7dO+0Vltz8+9uPeVXOvwH8Y3bx1ev7wjrMvLa8Ak6Gxg04SUhDIVADViJCLQ5GWsSe7malom7lxP7YhLK1sv5zcUwIOBaNpoyvw1YSUua5Q0MSrVkMpB4pAlrL2CxpKAQK/pCJvN+8l+CCIKWfpXtk/1zLxstDVW9oj1BSJx6AEv0GmsNMwwgkn6z49xBjItR6OxHrPG6qRU49TgBD8AeOHjk0eAmwkAAAAASUVORK5CYII=",aspectRatio:1.3333333333333333,src:"/static/build-your-own-cloud-fast-thanks-to-ansible-and-automation-e2c1afa375eac19e00705b12667cd199-8cfe2.png",srcSet:"/static/build-your-own-cloud-fast-thanks-to-ansible-and-automation-e2c1afa375eac19e00705b12667cd199-130b9.png 250w,\n/static/build-your-own-cloud-fast-thanks-to-ansible-and-automation-e2c1afa375eac19e00705b12667cd199-489bc.png 500w,\n/static/build-your-own-cloud-fast-thanks-to-ansible-and-automation-e2c1afa375eac19e00705b12667cd199-8cfe2.png 1000w,\n/static/build-your-own-cloud-fast-thanks-to-ansible-and-automation-e2c1afa375eac19e00705b12667cd199-eb1d2.png 1024w",sizes:"(max-width: 1000px) 100vw, 1000px"}}},path:"/blog/build-your-own-cloud-fast-thanks-to-ansible-and-automation",author:"Igor Rzegocki"}}},pathContext:{}}}});
//# sourceMappingURL=path---blog-build-your-own-cloud-fast-thanks-to-ansible-and-automation-8cb903515e621e3e5c38.js.map