{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/","result":{"data":{"allFile":{"edges":[{"node":{"publicURL":"/static/browserconfig-09e19ac7a78d68293c22953898762a5f.xml"}}]},"site":{"siteMetadata":{"siteUrl":"https://www.rzegocki.pl"}},"allMenuJson":{"edges":[{"node":{"id":"2e6028ce-fad1-487b-bace-6117f33e393f","name":"About","to":"about"}},{"node":{"id":"27dd36a1-f8af-4d43-8bab-c37310058c1e","name":"Technologies","to":"technologies"}},{"node":{"id":"447e8185-ac1a-42bc-a28c-4bc90e52735a","name":"Blog","to":"blog"}},{"node":{"id":"a9fc4afa-7b78-44d2-b015-4dac2ac2afe8","name":"Contact","to":"contact"}}]},"allShareJson":{"edges":[{"node":{"id":"2f0a723b-2772-40bf-9edc-70dd70337f10","slug":"facebook","name":"Facebook","url":"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup","width":626,"height":457}},{"node":{"id":"f5678f7f-ae05-444a-af1a-1167a30d0cce","slug":"linkedin","name":"LinkedIn","url":"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=","width":600,"height":450}},{"node":{"id":"4cbf0a18-d389-4583-98ac-501e59f1be18","slug":"twitter","name":"Twitter","url":"https://twitter.com/share?url=%POSTURL%&amp;text=","width":500,"height":550}}]},"markdownRemark":{"html":"<p>The next thing my paranoid me couldn't stand of is that my emails can be easily\nspoofed. Yeah, I know I'm not a very famous person, so probability of such\nthing happening is similar to zero, but hey - tell this to my Paranoid me. :)\nI also sign every mail I could (they can be easily verified using\n<a href=\"/files/978fcc6c1d13c23615cc2ed1ca7774ca/public-key.txt\">my public key</a>), but still - DKIM seems to be a fine\nsolution. And besides, I love to play with new things. So after many\nexperiments with <a href=\"https://sourceforge.net/projects/dkim-milter/\">dkim-milter</a>,\n<a href=\"https://sourceforge.net/projects/dkimproxy/\">DKIMProxy</a> and\n<a href=\"https://bit.ly/2PRstaj\">opendkim</a> I finally decided to use the last one.\nMostly because it's easiest to configure and is still maintained.</p>\n<!--more-->\n<h2>Installing and configuring opendkim</h2>\n<p>You will be suprised how simple it is. :) Firstly you need to install a proper\ndebian packages:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> opendkim libmail-dkim-perl</code></pre></div>\n<p>The second one is a dkim support for spamassassin. I'll cover that later. Next,\nyou need to edit your <code class=\"language-text\">/etc/opendkim.conf</code> file:</p>\n<p><code class=\"language-text\">/etc/opendkim.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">SysLog             yes\nUmask              002\n\nKeyTable           /etc/mail/dkim/KeyTable\nSigningTable       /etc/mail/dkim/SigningTable\nExternalIgnoreList /etc/mail/dkim/TrustedHosts\nInternalHosts      /etc/mail/dkim/TrustedHosts\n\nCanonicalization   relaxed/simple\nMode               sv\nX-Header           yes</code></pre></div>\n<p><code class=\"language-text\">Mode sv</code> directive tells opendkim to sign but also verify messages, while\n<code class=\"language-text\">X-Header</code> adds <code class=\"language-text\">X-Dkim</code> header (which contains information about the DKIM\ndaemon you are using). Next we need to tell opendkim which port it will be\nusing, so in <code class=\"language-text\">/etc/default/opendkim</code> uncomment:</p>\n<p><code class=\"language-text\">/etc/default/opendkim</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">SOCKET=\"inet:12345@localhost\" # listen on loopback on port 12345</code></pre></div>\n<p>Now we have to populate those extra files we defined. <code class=\"language-text\">TrustedHosts</code> is the\neasiest one, it's just the list of hosts and domains which are allowed to use\nDKIM. So in most cases:</p>\n<p><code class=\"language-text\">/etc/mail/dkim/TrustedHosts</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">localhost\n127.0.0.1\n192.168.1.1\n1.2.3.4 # external IP</code></pre></div>\n<p>Next, we need to create a key and DNS TXT record pair for each domain we want\nto be signed. I suggest to use strong key (<code class=\"language-text\">-b</code> parameter), to avoid\n<a href=\"https://www.wired.com/2012/10/dkim-vulnerability-widespread/\">some company's failure</a>\nTo do this:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token function\">mkdir</span> -p /etc/mail/dkim/keys/mydomain.com\n<span class=\"token builtin class-name\">cd</span> /etc/mail/dkim/keys/mydomain.com\nopendkim-genkey -r -b <span class=\"token number\">2048</span> -d mydomain.com -s mail\n<span class=\"token function\">chown</span> opendkim:opendkim mail.private\n<span class=\"token function\">chmod</span> <span class=\"token number\">600</span> mail.private</code></pre></div>\n<p>This will create two files: <code class=\"language-text\">mail.private</code> - which contains a private RSA key,\nand <code class=\"language-text\">mail.txt</code> which contains a contents for DNS TXT record. So let's make use\nof them! First keys - they need to be fined in <code class=\"language-text\">KeyTable</code> and <code class=\"language-text\">SingingTable</code>\nfiles.</p>\n<p><code class=\"language-text\">/etc/mail/dkim/KeyTable</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">mail._domainkey.mydomain.com mydomain.com:mail:/etc/mail/dkim/keys/mydomain.com/mail.private</code></pre></div>\n<p><code class=\"language-text\">/etc/mail/dkim/SigningTable</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">mydomain.com mail._domainkey.mydomain.com</code></pre></div>\n<p>The last thing we need to do is to add a DNS TXT record for\n<code class=\"language-text\">mail._domainkey.mydomain.com</code> domain containing contents provided by\n<code class=\"language-text\">opendkim-genkey</code>. For example for irgon.com it looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">mail._domainkey.irgon.com descriptive text \"v=DKIM1\\; g=*\\; k=rsa\\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAsfIThdXoizR6sop0gifPwPkT45I/KnTTNKDS4BHWtoU6as62c/3BRQuKqDAIacheZzWbfEPq/M2YvoNrVhx1laltg7aeUhZlcVOtz415lIy8M8oUVTCDxewBKsTEQD5M4Roaadoj7vzpA1JMcOEv36TizFq/KB5GL46pVNyOMJ+Mg\" \"97F+EQQeiOFsn/T+tNuxWky3l4Qky3S8U34wYmRSr+sVLu4U31QtocwL4uJ7ofVNdVk0baYo7s1HYnM3CGEKK+zdHTR/AoNiquvVX1lLX9s85bade4cNuRaINjzDyM4fAglLgSHZEtRcRlYqdMEpQcplI1OaSxIFS4DpFL3RwIDAQAB\"</code></pre></div>\n<p>And that settles DKIM. All we have left is starting it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span>/etc/init.d/opendkim start</code></pre></div>\n<h2>Connecting opendkim to postfix</h2>\n<p>This is really simple part.</p>\n<p><code class=\"language-text\">/etc/postfix/main.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\"># DKIM\nmilter_default_action = accept\nmilter_protocol = 6\nsmtpd_milters = inet:localhost:12345\nnon_smtpd_milters = inet:localhost:12345</code></pre></div>\n<p>then. reload it and you are set.</p>\n<h2>Installing SPF</h2>\n<p>Ok, now THAT is simple. Just install package:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> postfix-policyd-spf-python</code></pre></div>\n<p>and add service:</p>\n<p><code class=\"language-text\">/etc/postfix/master.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">policy-spf  unix  -  n  n  -  -  spawn user=nobody argv=/usr/bin/policyd-spf</code></pre></div>\n<p>Add spf timeout to <code class=\"language-text\">/etc/postfix/main.cf</code> and adjust\n<code class=\"language-text\">smtpd_recipient_restrictions</code> to include\n<code class=\"language-text\">check_policy_service unix:private/policy-spf</code>, so in my file it looks like\nthis:</p>\n<p><code class=\"language-text\">/etc/postfix/main.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">[...]\nsmtpd_recipient_restrictions = reject_unauth_pipelining,\n                               permit_sasl_authenticated,\n                               permit_mynetworks,\n                               reject_non_fqdn_recipient,\n                               reject_unknown_recipient_domain,\n                               reject_unauth_destination,\n                               reject_unknown_sender_domain,\n                               check_policy_service unix:private/policy-spf\n[...]\nspf-policyd_time_limit = 3600s</code></pre></div>\n<p>Last but not least is updating a DNS record. This is simple and similar to DKIM -\njust ad TXT record to your TLD containing <code class=\"language-text\">v=spf1 a mx ip4:&lt;your ip&gt;</code>, for\nexample my looks like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">irgon.com descriptive text \"v=spf1 a mx ip4:213.134.188.213\"</code></pre></div>\n<p>Don't forget to restart your Postfix when you're done!</p>\n<h2>Testing</h2>\n<p>To test if everything works fine, just send yourself an email and check it\nheaders. You should see something like:</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token header-name keyword\">X-Dkim:</span> OpenDKIM Filter v2.0.1 myexample.com 0224020B8\n<span class=\"token header-name keyword\">Dkim-Signature:</span> v=1; a=rsa-sha256; c=relaxed/simple; d=myexample.com; s=mail; t=1351357546; bh=Rskt6Q/nZKmxgXkWUYP6cCBSDJhtkVT0PSrUEVGVgp4=; h=From:Content-Type:Content-Transfer-Encoding:Subject:Message-Id: Date:To:Mime-Version; b=phPQdG6HYaders4Xv0TsK2mT+PFYVk/brOFpnmCjCZtvbeGJ+XwrNk4Tnc9xGELtAglLOVplSvMV9nTK6xonta1qLTtnLYPsY4o/WPfyZYDgHmp6X9ZYP4otAHYK3jC00PbKGNqhXeD3bCc7CBV/aVGMQX4Bt0TjAAgndeYCI9VnvR2zH0iTEjlAT2OXrh2JV+wrK5UOXae8gRPT28F2Mg325YOiDwD1T5bgFtfc9mh2s/NRcy7lyDiPcb3CNV+nMXKyq/47o22LlALv5g5+OBBZACQYpYtgalM54InQDPoL/udvKtI/YYaiByFLwqeYFh2LXX6et 9dAiNCRLL+EoA==</code></pre></div>\n<p>Which means that singing is alive and kicking. To test verification, just send\nyourself an email from DKIM-using provider (like Yahoo or Gmail) and check for\nfollowing header:</p>\n<div class=\"gatsby-highlight\" data-language=\"http\"><pre class=\"language-http\"><code class=\"language-http\"><span class=\"token header-name keyword\">Authentication-Results:</span> myexample.com; dkim=pass (2048-bit key; insecure key) header.i=@gmail.com; dkim-adsp=pass</code></pre></div>\n<p>Which means, that verfication is working. As the last final test, send email to\n`autorespond+dkim@dk.elandsys.comz. This is automated service, which checks\nyour DKIM headers for you and sends back the results. If you get DKIM Signature\nvalidation: passz in the body, then it means, that everything is working\nproperly.</p>\n<h2>Final polishing</h2>\n<p>By default spamassassin has DKIM filters enabled. To ensure, look for\n<code class=\"language-text\">loadplugin Mail::SpamAssassin::Plugin::DKIM</code> in your\n<code class=\"language-text\">/etc/spamassassin/v312.pre</code> file. When it's enabled you should see values like\n<code class=\"language-text\">DKIM_VALID</code> or <code class=\"language-text\">T_DKIM_INVALID</code> in <code class=\"language-text\">X-Spam-Status</code> header. Normally,\nspamassassin puts a very little weight to that rules, but you can easily\nincrease it by adding:</p>\n<p><code class=\"language-text\">/etc/mail/spamassassin/local.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">score T_DKIM_INVALID 10\nscore DKIM_ADSP_CUSTOM_MED 10</code></pre></div>\n<p>You can also add sieve filter based on <code class=\"language-text\">Authentication-Results</code> if you want to\ntreat those suspicious messages differently than normal spam:</p>\n<p><code class=\"language-text\">.dovecot.sieve</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">if header :contains \"Authentication-Results\" \"dkim=fail\" { fileinto \"DANGER\"; stop; }</code></pre></div>\n<p>The possibilities are endless :)</p>\n<h3>Sources</h3>\n<ul>\n<li><a href=\"https://bit.ly/1uCt6pY\">http://blog.tjitjing.com/index.php/2012/03/guide-to-install-opendkim-for-multiple-domains-with-postfix-and-debian.html</a></li>\n<li><a href=\"https://web.archive.org/web/20120625134223/https://syslog.tv/2011/09/17/postfix-dk-dkim-spf/\">https://syslog.tv/2011/09/17/postfix-dk-dkim-spf/</a></li>\n</ul>","excerpt":"The next thing my paranoid me couldn't stand of is that my emails can be easily\nspoofed. Yeah, I know I'm not a very famous person, soâ€¦","frontmatter":{"id":"1cb813c7-2585-4511-a7bc-ef92140611d9","title":"Add more complexity to your Emails - use DKIM and SPF","date":"October 27, 2012","isoDate":"2012-10-27T11:15:00.000Z","cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABcBAAMBAAAAAAAAAAAAAAAAAAECAwT/2gAMAwEAAhADEAAAAY3qo3QiMA3/xAAaEAEAAgMBAAAAAAAAAAAAAAABAAMCERIx/9oACAEBAAEFAudtlIDjO2N7mPv/xAAWEQEBAQAAAAAAAAAAAAAAAAAAETH/2gAIAQMBAT8BxX//xAAWEQEBAQAAAAAAAAAAAAAAAAABABL/2gAIAQIBAT8BRWzf/8QAFxABAQEBAAAAAAAAAAAAAAAAAREQAP/aAAgBAQAGPwIDqXZM/8QAGBABAQEBAQAAAAAAAAAAAAAAAQAhETH/2gAIAQEAAT8hHQFAIB9jtmTRCM//2gAMAwEAAgADAAAAEOgP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAh/9oACAEDAQE/EBBsC//EABcRAQEBAQAAAAAAAAAAAAAAAAEAETH/2gAIAQIBAT8QKJyXt//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExUaH/2gAIAQEAAT8QsTpQfIyBHRbG5VUH2aeg5sAfE72pYlWf/9k=","aspectRatio":1.5585996955859969,"src":"/static/7e4dc2298be7dce9337581981c6c27b9/2f7e7/add-more-complexity-to-your-emails-use-dkim-and-spf.jpg","srcSet":"/static/7e4dc2298be7dce9337581981c6c27b9/4d406/add-more-complexity-to-your-emails-use-dkim-and-spf.jpg 250w,\n/static/7e4dc2298be7dce9337581981c6c27b9/32ee9/add-more-complexity-to-your-emails-use-dkim-and-spf.jpg 500w,\n/static/7e4dc2298be7dce9337581981c6c27b9/2f7e7/add-more-complexity-to-your-emails-use-dkim-and-spf.jpg 1000w,\n/static/7e4dc2298be7dce9337581981c6c27b9/426ce/add-more-complexity-to-your-emails-use-dkim-and-spf.jpg 1024w","sizes":"(max-width: 1000px) 100vw, 1000px"}}},"path":"/blog/add-more-complexity-to-your-emails-use-dkim-and-spf/","author":"Igor Rzegocki"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}