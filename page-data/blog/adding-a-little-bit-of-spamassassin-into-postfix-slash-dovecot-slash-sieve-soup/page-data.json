{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup/","result":{"data":{"allFile":{"edges":[{"node":{"publicURL":"/static/c572c87cb69383ddb09f62960f02f969/browserconfig.xml"}}]},"site":{"siteMetadata":{"siteUrl":"https://www.rzegocki.pl"}},"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEu0lEQVQ4y22TfUxTVxjGD72lvW1HZclIJrqZGEw0WZj7Y8syp4ssaJxzcQzUhSBuOkDUyVCZVScyCDGo4LbAdMvAzKhj0MqHVYdGlA0HEwXlswhFgTKnFtoi2N57e56d25VWzd7kyXs+f/c57zmXEBYqlconjuOIVqslarVa7qtYns+0iamc6VOmGUwqnud9a5gUT7RJIPwAEh0dTRYvXiz3NzNZ2GI8IxfTLaYKNv+6H8T9L1D+mj+/ouZ5qtFoZIBXFRrqZWMiMybJULVKBdaX51qYiYgn98qmAnY1PK9gEMIWHmVtKDjOrVCq6PTISKrV6WhYmJ6qeQ3VTwuXdDqd2w+99EJEhA/0LNBXC16jmcfaQmioCpEzZtKDe7dQQ0YK/ThhJZbGxmDFslianLiKznzpZcrqLfocq9UJU4wgkFdzSnYhGl6dqVLzWPLuO+KFk4UYbCilV8oL0VBRhFZzCRpZPl+WR3N2pNEXp88Q/S6PyQyWfccmUx1/OU1zZs9Ce12pKHQZ0ddSB0huwNkP3G8DIMLWdRWTHUZ8m/uFSBRKaDWaI0qlMgj0n38KuOiN+fNEr6UagvUSZQQIEsWYwwmH04lHE4/lIUptTdTVeorOjZoFtmeB/2KDwLDndIEbLyvY1iH1mCAMNUny5sceEQ/vDWHcbsPomNMH9Iy0SeitwgHDZ9dZn8gKPB0ZKA9Mdp7mYLtApN7aE0JPFYRes+h1jYAKk5AGGyEM1LPje+B1uyD2XxDdXSZMdJwummg3koctv3BPvUM5hJ5qhae7mjhvVsSKlhp4uk9TobuKym1Ya4GBWoi9tRAstZTNQeqtkZxtFa8JlhrZhO+VBCJ67mzm8i4ZaC5X3G/9lYy3m35GnxmSpUYcvVGOeuOPuGQqg/1GJby9NSK9fQbDzadKu+qPkp4rpdyS5OUkKioqCPR6vSR99yYyZ00S0b35KpeWtaHhoqmIOTsr4c551J84AGNJDnN5Dug3e83lB7EuI8kaE78wImZNLFmV8mEIpTQIlGt47/4INz7uJC7X2OqbnW3IKdwnFRfvodfrfoCt+RSGm07i6pliHP7GgD0Fu4XGv37HnUFrpvVuH+m+3cnJjKeAbo+ocHskuV0pX2VtXZW4dmsSNhrSkJf3CfJzk5G+MwXJGcn0eOUx+QXIcQ3Di9iem+Qp4NDQcEhX3yDp7BsOd9gfWCddozh0pMC78csNNDN7C83NXod9uxKxPXsT0g0pNLcomzrtI7A/uOcZc03Mc45PEofDoQgAm/+4HPLT2XZScqZTP9pu/vvRLSO+3r9DSs1KgSEvjX5XvB6Fh9dj7/5UbNyZQvMLsryeDhPGLRcdzX2OyBtWBxnovx0SABqqncTefk4BWyOB1Zz2J/tvs3K3Yhv7vXIOfS4dKkn3Fn2fTvMPb6YZ+7ZSQ36m2MDqaWs6vr3naiVpu1LO9Qzag0f+4Lf/Xntq+gaF8ehXJCZhxYKFMW8Ly1YuQVziSsSvXYWEdatZjkfC2jgsj1uGpR+9V0U8CNlVf5C8nxpH7trFINB6udSXFYSbsv0Wr+RbtSrtdb027Fq4flo308Pn9eF2vU7/j06toypFaCUrWuCYLefKfPlfC5bF+yGL26YAAAAASUVORK5CYII=","width":192,"height":192,"src":"/static/288480e5b155377d1ae8a338e27da1ef/f20a7/ajgon.png","srcSet":"/static/288480e5b155377d1ae8a338e27da1ef/f20a7/ajgon.png 1x,\n/static/288480e5b155377d1ae8a338e27da1ef/6c7c3/ajgon.png 1.5x,\n/static/288480e5b155377d1ae8a338e27da1ef/6a040/ajgon.png 2x"}}},"allMenuJson":{"edges":[{"node":{"id":"2e6028ce-fad1-487b-bace-6117f33e393f","name":"About","to":"about"}},{"node":{"id":"27dd36a1-f8af-4d43-8bab-c37310058c1e","name":"Technologies","to":"technologies"}},{"node":{"id":"447e8185-ac1a-42bc-a28c-4bc90e52735a","name":"Blog","to":"blog"}},{"node":{"id":"a9fc4afa-7b78-44d2-b015-4dac2ac2afe8","name":"Contact","to":"contact"}}]},"allShareJson":{"edges":[{"node":{"id":"2f0a723b-2772-40bf-9edc-70dd70337f10","slug":"facebook","name":"Facebook","url":"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup","width":626,"height":457}},{"node":{"id":"f5678f7f-ae05-444a-af1a-1167a30d0cce","slug":"linkedin","name":"LinkedIn","url":"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=","width":600,"height":450}},{"node":{"id":"4cbf0a18-d389-4583-98ac-501e59f1be18","slug":"twitter","name":"Twitter","url":"https://twitter.com/share?url=%POSTURL%&amp;text=","width":500,"height":550}}]},"allSocialJson":{"edges":[{"node":{"id":"587d3ac1-40e9-4cc1-a610-f8cb9657bfbc","name":"GitHub","slug":"github","url":"https://github.com/ajgon"}},{"node":{"id":"d97c572d-7410-413c-89bd-ee620e901fce","name":"LinkedIn","slug":"linkedin","url":"https://www.linkedin.com/in/ajgon"}},{"node":{"id":"6928828d-8198-4387-a5f6-3a1036179c08","name":"Keybase","slug":"keybase","url":"https://keybase.io/ajgon"}}]},"markdownRemark":{"html":"<p>I was always prefering \"stay in the shadows\" policy in terms of email address.\nI have two secondary emails (for spam I want to read, and for spam I want to be\nsent into oblivion i.e. for \"Register NOW to download this 2KB file\" sites). My\nprimary e-mail was well guarded and given only to living people. Until one\ncompany decided to show it to the whole world by putting it into WHOIS database\nfor my domain. Before I reacted, it was too late. And my little mail server\nneeded one more extension.</p>\n<!--more-->\n<p>I wanted to integrate it somehow with my existing configuration - so, when\nmessage is parsed by spam filter, it needs to be filtered further by sieve.\nThanks to that, I can have full control over spam and even categorize it (yeah,\nI'm a picky bastard ;)). Thankfully\n<a href=\"https://spamassassin.apache.org/\">SpamAssassin</a> can do this, so I didn't have\nto look further. I also decided to inlcude\n<a href=\"https://sourceforge.net/projects/pyzor/\">Pyzor</a>,\n<a href=\"https://sourceforge.net/projects/razor/\">Razor</a> and\n<a href=\"https://www.dcc-servers.net/dcc/\">DCC</a>. No mercy!</p>\n<h2>Installing packets</h2>\n<p>But first - necessary packets. Thankfully, debian has everything out of box,\nexcept DCC.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> spamc spamassassin pyzor razor</code></pre></div>\n<p>Next is DCC, which has to be build manually:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token function\">groupadd</span> dcc\n<span class=\"token function\">useradd</span> -g dcc -s /bin/false -d /var/dcc dcc\n<span class=\"token function\">wget</span> http://www.dcc-servers.net/dcc/source/dcc-dccproc.tar.Z\n<span class=\"token function\">tar</span> xzvf dcc-dccproc.tar.Z\n<span class=\"token builtin class-name\">cd</span> dcc-dccproc-1.3.142\n./configure --with-uid<span class=\"token operator\">=</span>dcc\n<span class=\"token function\">make</span>\n<span class=\"token function\">make</span> <span class=\"token function\">install</span>\n<span class=\"token function\">chown</span> -R dcc:dcc /var/dcc\n<span class=\"token function\">ln</span> -s /var/dcc/libexec/dccifd /usr/local/bin/dccif</code></pre></div>\n<h2>Setting up SpamAssassin</h2>\n<p>The next step is to configure <code class=\"language-text\">spamd</code> to run as a daemon:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span>groupdd spamd\n<span class=\"token function\">useradd</span> -g spamd -s /bin/false -d /var/lib/spamassassin spamd\n<span class=\"token function\">mkdir</span> -p /var/lib/spamassassin\n<span class=\"token function\">chown</span> spamd:spamd /var/lib/spamassassin -R</code></pre></div>\n<p><code class=\"language-text\">/etc/default/spamassassin</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\"># Spamassassin home\nSAHOME=\"/var/lib/spamassassin\"\n\n# Where imap stores user emails\nUSERACCOUNTS=\"/home/vmail\"\n\n# Change to one to enable spamd\nENABLED=1\n\n# Options\n# See man spamd for possible options. The -d option is automatically added.\n\n# SpamAssassin uses a preforking model, so be careful! You need to\n# make sure --max-children is not set to anything higher than 5,\n# unless you know what you're doing.\n# For -A use the IP address of spamc client (probably IP of primary interface)\nOPTIONS=\"--create-prefs -x --max-children 3 --username spamd --helper-home-dir ${SAHOME} -s ${SAHOME}/spamd.log --virtual-config-dir=${USERACCOUNTS}/%l@%d/spamassassin -A 192.168.1.1\"\n\n[...]</code></pre></div>\n<p>The <code class=\"language-text\">virtual-config-dir</code> allows us to have separate user preferences and bayes\ndatabases for each virtual user. The next thing is to edit\n<code class=\"language-text\">/etc/spamassassin/local.cf</code> file:</p>\n<p><code class=\"language-text\">/etc/spamassassin/local.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">[...]\n# Save spam messages as a message/rfc822 MIME attachment instead of\n# modifying the original message (0: off, 2: use text/plain instead)\nreport_safe 0\n[...]\n\nuse_dcc 1\ndcc_path /usr/local/bin/dccproc\n\nuse_pyzor 1\npyzor_path /usr/bin/pyzor\n\nuse_razor2 1\nrazor_config /etc/razor/razor-agent.conf</code></pre></div>\n<p>Afterwards, edit <code class=\"language-text\">/etc/spamassassin/v310.pre</code> and check that the DCC, Razor and\nPyzor plugins are enabled (DCC is disabled by default). After that, the only\nthing left is to update SA databases and start it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span>sa-update --no-gpg\n/etc/init.d/spamassassin start</code></pre></div>\n<h2>Setting up postfix transport</h2>\n<p>From the postfix side all you have to do is change transport (I suggest to\ncreate a new one - then, when something goes wrong you can easily switch back\nto old working configuration) or <code class=\"language-text\">mailbox_command</code>. For transport, the magic\nline looks like this:</p>\n<p><code class=\"language-text\">/etc/postfix/master.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">dovecot-spam   unix  -       n       n       -       -       pipe\n    flags=DRhu user=vmail:vmail argv=/usr/bin/spamc -u ${recipient} -e /usr/lib/dovecot/deliver -d ${recipient}</code></pre></div>\n<p>And this is the line I've been looking for. SpamAssassin takes message, pushes\nit through his intestines, adds headers, and output is pushed further to\n<code class=\"language-text\">deliver</code> command. From that point, it can be taken by Sieve. To make this\nwork, don't forget to change the transport!</p>\n<p><code class=\"language-text\">/etc/postfix/main.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">mailbox_transport = dovecot-spam</code></pre></div>\n<p>Restart postfix:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span>/etc/init.d/postfix restart</code></pre></div>\n<h2>And finally... Sieve</h2>\n<p>After all of that, all you have to do is configure Sieve. For example like that\n(<em>Junk</em> is a folder which Thunderbird traditionally uses for spam, you can\nchange it of course):</p>\n<p><code class=\"language-text\">.dovecot.sieve</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">if header :contains \"X-Spam-Flag\" [\"YES\"] { fileinto \"Junk\"; stop; }</code></pre></div>\n<p>To test it, just send an email to protected account and look into the headers.\nYou should see a SpamAssassin magic added there. To test filtering, use\n<a href=\"https://spamassassin.apache.org/gtube/\">GTUBE</a> message format - your email\nshould land in Junk.</p>\n<h2>Conclusion</h2>\n<p>I think this configuration will suit my needs. Probably it will get some\nadjustments over time (like intelligent filters in SA and so on), and - when I\nstart to trust it fully - instead of moving into the Junk all spam will be\ndeleted. But for now, everything works like a charm :) If you experience any\nproblems, first look into <code class=\"language-text\">/var/lib/spamassassin/spamd.log</code> file - there is big\nchance, that you'll find your answers there.</p>\n<h3>Sources</h3>\n<ul>\n<li><a href=\"https://web.archive.org/web/20130917110312/http://ailoo.net/2009/11/integrate-spamassassin-into-postfix-dovecot\">Integrate Spamassassin into Postfix/Dovecot</a></li>\n</ul>","excerpt":"I was always prefering \"stay in the shadows\" policy in terms of email address.\nI have two secondary emails (for spam I want to read, and for…","frontmatter":{"id":"2b8aa887-ec53-4920-bc16-48f4a05091c5","title":"Adding a little bit of SpamAssassin into Postfix, Dovecot, Sieve soup","date":"July 21, 2012","isoDate":"2012-07-21T10:16:00.000Z","tags":["administration"],"cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAPABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAYcmVMxB/wD/xAAYEAADAQEAAAAAAAAAAAAAAAAAAQIREP/aAAgBAQABBQLmk1qHR//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAACBC/9oACAEBAAY/ApX/xAAbEAEAAwADAQAAAAAAAAAAAAABABEhMWGB4f/aAAgBAQABPyFd6b7L4+xig3atAisoZ//aAAwDAQACAAMAAAAQvO//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPxBH/8QAHxABAAIBAwUAAAAAAAAAAAAAAQARMSFR8EFhgZHh/9oACAEBAAE/ECqODEvTVEbNAp2AXX19E1MPPMTAMAjJuy4r0yrac0hUrb3n/9k=","aspectRatio":1.3297872340425532,"src":"/static/54d64aef10c4988191b996a934c3cb4d/a7715/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.jpg","srcSet":"/static/54d64aef10c4988191b996a934c3cb4d/8f7df/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.jpg 250w,\n/static/54d64aef10c4988191b996a934c3cb4d/0f3a1/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.jpg 500w,\n/static/54d64aef10c4988191b996a934c3cb4d/a7715/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.jpg 1000w,\n/static/54d64aef10c4988191b996a934c3cb4d/e8e8a/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.jpg 1269w","srcWebp":"/static/54d64aef10c4988191b996a934c3cb4d/e30b5/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.webp","srcSetWebp":"/static/54d64aef10c4988191b996a934c3cb4d/7ca0e/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.webp 250w,\n/static/54d64aef10c4988191b996a934c3cb4d/e9589/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.webp 500w,\n/static/54d64aef10c4988191b996a934c3cb4d/e30b5/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.webp 1000w,\n/static/54d64aef10c4988191b996a934c3cb4d/33530/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup.webp 1269w","sizes":"(max-width: 1000px) 100vw, 1000px"}}},"path":"/blog/adding-a-little-bit-of-spamassassin-into-postfix-slash-dovecot-slash-sieve-soup/","author":"Igor Rzegocki"}}},"pageContext":{}}}