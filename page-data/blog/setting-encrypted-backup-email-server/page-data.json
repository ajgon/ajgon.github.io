{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/setting-encrypted-backup-email-server/","result":{"data":{"allFile":{"edges":[{"node":{"publicURL":"/static/09e19ac7a78d68293c22953898762a5f/browserconfig.xml"}}]},"site":{"siteMetadata":{"siteUrl":"https://www.rzegocki.pl"}},"avatar":{"childImageSharp":{"fixed":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsSAAALEgHS3X78AAAEbUlEQVQ4y21Te1BUZRS/y7KPy+42EJMmpTZTTTX+U9ljnJ40TTk1ZVCWiyIaLAiJoiSKKCJijG4Rg1NAROAklbwMBtwxBdoRMTDiIcsjXjLiroDgAgLr3nu/X9+97i4wdmZ+e853v3N+93fOucsw1BQKBeM2lmU9sUqleoxCT5FPsYHCn1lg9OwlerVaLcaLLhilUsn4+Pi4z+spGmjiLAUWYJTiMkUBvX9pIambYyGpzOUfpbBTpWBZNZRKBVGrVTx9xouk1LvJ/6HxkoWkEqGbmSbIXfJTRTKFt7eDkcnJQ0uWEpb1IVqtlihVKkGr1fEajcbhIjUrFN4ehfepU6vZZWqVapzOFL5+/kJibBjZuyOCBK97H4FvvoG3A18nG9YHkRUrVhK5XO4UX0xrQ90qPQopJHU+rHqTQqnCyy+u5otz0nDjUiGpKTqOC0VGNJRlou4XI6rzU0lyfCRZ+nAA72q/3NWZl6RS/HG3yzCyguWPBMBceoLju8rR01BBnLN2wN4H2JoAYQbXLfWYbC1GdvoeTu6tBKtWlywiFGW6h0ptzdNPrHTMdZSB6/+DADwRAExOTlNMYmb2Lj2BEGsTcXQUC8+uehK05qOFi5FMq/HxxN8kRTZioArcUD0vFjucHEZsw5get2Ls1rhE6LhpETBsQsaBqH5xuW4Oj8LDOzcy6K+W2nZ2V/4A6wU4e6o4YdoGwjsJb22Gc7COtuyEwDnADf7J4fo5TLaVFok1482/3b/pOcsZ6eFkW8lrGDiLu11niLO7gnC9Z4H+SmCgEjyNnf+aCL0TMGjCrKX8HbGG66n0emX1qnmypx5fzgB9zNBfRRKpo6siF7Za0ETe3nKaNFYXoqH6FMaaS8B1/86Ld+OtpRVibkddnhcdA+OlCZgnFASBeTf0PQZWs3Q2xG8pazB9D6qCxzUT/XSM+MmYCNJbBXoWGk3ZMMSHDT239vllYv4nhiDZ3Nwss8hu2IYldVNT9rc6ey1I/fawkJudTNpr8zHafFpC2/k8/Jibgn1fJTgvtzSgu7fzoFhzpbVRmr9Op7tHJkrmeEHuirPFVdZcPM9t3hmKmP3RJC0tAseObsX2xEhsjgsjeUU54hcg2tU70zZvN4fHrDab5GubupT22xMtdJ3IPvkdvy0hnMQdiiWpKVtwJCkEXybH4Iv920iyMYncHr9J7BNjxD4188K9zqa8PAobL5ml//LWkyOq0XZTPwbO4XhGIheZYMC+I9EkMyscX2d8joPpUZQwiqSkx5M77WWY7qnhr/YNS+u91t87Tyi9wVIlzZB+1FFd5kIcSN+NXalxXIoxVsjMiRaycqPJsawYEpeyg+w9usvZUf8zRq4UZUgzrPtVzvyfxe6OkkiDDfo1gWsDp4P0H0If/hk2Rm5CiAiDHiERn+Lj0GB8oF938dVDe7Ri/vakSNnfs5hfyqC5wM0pc/lnWAXbrFFpOn11vm3+fg/2Ukz4+/nb/R7wu6VjdVDJlVU0z6PMUntK8v8Bt8WCTNzAZZUAAAAASUVORK5CYII=","width":192,"height":192,"src":"/static/288480e5b155377d1ae8a338e27da1ef/f20a7/ajgon.png","srcSet":"/static/288480e5b155377d1ae8a338e27da1ef/f20a7/ajgon.png 1x,\n/static/288480e5b155377d1ae8a338e27da1ef/6c7c3/ajgon.png 1.5x,\n/static/288480e5b155377d1ae8a338e27da1ef/6a040/ajgon.png 2x"}}},"allMenuJson":{"edges":[{"node":{"id":"2e6028ce-fad1-487b-bace-6117f33e393f","name":"About","to":"about"}},{"node":{"id":"27dd36a1-f8af-4d43-8bab-c37310058c1e","name":"Technologies","to":"technologies"}},{"node":{"id":"447e8185-ac1a-42bc-a28c-4bc90e52735a","name":"Blog","to":"blog"}},{"node":{"id":"a9fc4afa-7b78-44d2-b015-4dac2ac2afe8","name":"Contact","to":"contact"}}]},"allShareJson":{"edges":[{"node":{"id":"2f0a723b-2772-40bf-9edc-70dd70337f10","slug":"facebook","name":"Facebook","url":"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup","width":626,"height":457}},{"node":{"id":"f5678f7f-ae05-444a-af1a-1167a30d0cce","slug":"linkedin","name":"LinkedIn","url":"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=","width":600,"height":450}},{"node":{"id":"4cbf0a18-d389-4583-98ac-501e59f1be18","slug":"twitter","name":"Twitter","url":"https://twitter.com/share?url=%POSTURL%&amp;text=","width":500,"height":550}}]},"allSocialJson":{"edges":[{"node":{"id":"587d3ac1-40e9-4cc1-a610-f8cb9657bfbc","name":"GitHub","slug":"github","url":"https://github.com/ajgon"}},{"node":{"id":"d97c572d-7410-413c-89bd-ee620e901fce","name":"LinkedIn","slug":"linkedin","url":"https://www.linkedin.com/in/ajgon"}},{"node":{"id":"6928828d-8198-4387-a5f6-3a1036179c08","name":"Keybase","slug":"keybase","url":"https://keybase.io/ajgon"}}]},"markdownRemark":{"html":"<p>There is a popular Internet saying that people are divided into two groups -\nthose who make backups, and those who will. I strongly believe into that,\nthat's why despite that I trust my mailserver setup completely, I still want to\nkeep them in some other safe place. Probably somewhere, where somebody else\ntakes care of everything :) That's why I chose\n<a href=\"https://mail.zoho.com/\">ZOHO MAIL</a> as my backup server.</p>\n<!--more-->\n<p>Mostly for three reasons:</p>\n<ul>\n<li>They have IMAP</li>\n<li>They have enough space for free</li>\n<li>They also provide a nice webmail</li>\n</ul>\n<p>So my next task was to configure postfix in a way, that it will deliver all the\nmessages as it does currently, but also forward them to zoho.com. Of course I\nwasn't THAT crazy, to send my private emails over the Internet as they are, so\nI also needed some kind of encryption before that. It appeared that somebody\nhad the same problem, and there is a tool for that called\n<a href=\"https://code.google.com/archive/p/gpg-mailgate/\">gpg-mailgate</a>. Unfortunately it's a\nvery unfinished application, and lots of things doesn't work (multipart\nmessages support, attachmenets encryption, extra email encryption and so on),\nso I needed to do\n<a href=\"https://github.com/ajgon/gpg-mailgate\">a little bit of extra hacking</a>. And I\nstrongly recommend you, to use my version if you thinking about encrypting your\nemail out of the box. Ok, that's for the beginning - let's do some\nconfiguration!</p>\n<h2>Setting gpg</h2>\n<p>First thing is to install and configure a gpg account. I strongly recommend to\nnot to use your gpg keys (if you already have some), but create new, clean key.\nAlso, we need a new user in the file system for postfix to handle key support.\nLastly, gpg-mailgate comes with a Python library, which also needs to be\ninstalled.</p>\n<p>Install GPG:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> gpg</code></pre></div>\n<p>Create a gpg user and give him the key (don't forget to disable the password,\nand set trust to ultimate - otherwise tour scripts will stop to ask about\nconfirmation - and eventually fail):</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token function\">useradd</span> -s /bin/false -d /var/gpg -M gpgmap\n<span class=\"token function\">mkdir</span> -p /var/gpg/.gnupg\n<span class=\"token function\">chown</span> -R gpgmap /var/gpg\n<span class=\"token function\">chmod</span> <span class=\"token number\">700</span> /var/gpg/.gnupg\n<span class=\"token function\">sudo</span> -u gpgmap /usr/bin/gpg --gen-key --homedir<span class=\"token operator\">=</span>/var/gpg/.gnupg\n<span class=\"token function\">sudo</span> -u gpgmap gpg --edit-key your@key.email.com trust quit</code></pre></div>\n<h2>Setting gpg-mailgate</h2>\n<p>Install GnuPG Python library, and gpg-mailgate itself:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token builtin class-name\">cd</span> /root\n<span class=\"token function\">git</span> clone https://github.com/ajgon/gpg-mailgate.git\n<span class=\"token builtin class-name\">cd</span> gpg-mailgate\n<span class=\"token function\">cp</span> -R GnuPG /usr/lib/python2.6\n<span class=\"token function\">cp</span> gpg-mailgate.py /usr/local/bin/gpg-mailgate.py\n<span class=\"token function\">cp</span> gpg-mailgate.conf.sample /etc/gpg-mailgate.conf</code></pre></div>\n<p>Config file is pretty explanatory - what you have to change is \"domains\"\nparameter (put only domains, which you want to receive encrypted messages),\nkeyhome (set to <code class=\"language-text\">/var/gpg/.gnupg</code>) and keymap (map all the emails which should\nreceive encrypted content there - follow the hint in file). So all in all your\nconfig file should look similar to this:</p>\n<p><code class=\"language-text\">/etc/gpg-mailgate.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\"><span class=\"token selector\">[default]</span>\n<span class=\"token constant\">add_header</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> yes</span>\n<span class=\"token constant\">domains</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> zoho.com</span>\n\n<span class=\"token selector\">[gpg]</span>\n<span class=\"token constant\">keyhome</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> /var/gpg/.gnupg</span>\n\n<span class=\"token selector\">[logging]</span>\n<span class=\"token constant\">file</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> /tmp/gpg-mailgate.log</span>\n\n<span class=\"token selector\">[relay]</span>\n<span class=\"token constant\">host</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 127.0.0.1</span>\n<span class=\"token constant\">port</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 10028</span>\n\n<span class=\"token selector\">[keymap]</span>\n<span class=\"token constant\">email.which.will.receive.encrypted.content@zoho.com</span> <span class=\"token attr-value\"><span class=\"token punctuation\">=</span> 123456789ABCDEF</span></code></pre></div>\n<h2>Setting postfix</h2>\n<p>The last thing is postfix configuration which is (surprisingly) really easy,\njust activate content filter in <code class=\"language-text\">main.cf</code> and add relay to <code class=\"language-text\">master.cf</code>. One\nlast thing is to add <code class=\"language-text\">X-GPG-*</code> headers to tell the script, which extra email\naddresses we want to deliver messages encrypted. Normally gpg-mailgate encrypts\nonly messages to addresses that are configured in gpg-mailgate.conf file and\navailable in To/Cc/Bcc headers of original message. Unfortunatelly, we are\nusing a totally different zoho.com email intended only for backups - it will\nnever appear in original message headers, because it's not the recipient. To\nmake it appear - simply add <code class=\"language-text\">X-GPG-Encrypt-Cc</code> header to your message. So, the\nconfiguration will present as follows:</p>\n<p><code class=\"language-text\">/etc/postfix/main.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\"># gpg\nheader_checks = regexp:/etc/postfix/header_checks\ncontent_filter = gpg-mailgate</code></pre></div>\n<p><code class=\"language-text\">/etc/postfix/header_checks</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\">/^From: .*/ PREPEND X-GPG-Encrypt-Cc: email.which.will.receive.encrypted.content@zoho.com</code></pre></div>\n<p><code class=\"language-text\">/etc/postfix/master.cf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"none\"><pre class=\"language-none\"><code class=\"language-none\"># gpg-mailgate\ngpg-mailgate    unix    -       n       n       -       -       pipe\n  flags= user=gpgmap argv=/usr/local/bin/gpg-mailgate.py\n\n127.0.0.1:10028 inet    n       -       n       -       10      smtpd\n        -o content_filter=\n        -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks\n        -o smtpd_helo_restrictions=\n        -o smtpd_client_restrictions=\n        -o smtpd_sender_restrictions=\n        -o smtpd_recipient_restrictions=permit_mynetworks,reject\n        -o mynetworks=127.0.0.0/8\n        -o smtpd_authorized_xforward_hosts=127.0.0.0/8</code></pre></div>\n<p>Don't forget to create <code class=\"language-text\">header_checks.db</code> and restart postfix.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span>postmap header_checks\n/etc/init.d/postfix restart</code></pre></div>\n<p>And that's pretty much everything. Send yourself an email, and enjoy your new,\nshiny and secure backup :)</p>\n<h3>Sources</h3>\n<ul>\n<li><a href=\"https://ultramegaman.wordpress.com/tag/gpg-mailgate/\">GPG-Encrypting your incoming mail using Postfix and Google Apps</a></li>\n</ul>","excerpt":"There is a popular Internet saying that people are divided into two groups -\nthose who make backups, and those who will. I strongly believeâ€¦","frontmatter":{"id":"5e6be7dc-e19a-4ae4-ad4b-13f4c48d9401","title":"Setting encrypted backup Email server","date":"April 14, 2013","isoDate":"2013-04-14T11:34:00.000Z","tags":["administration"],"cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAADBP/aAAwDAQACEAMQAAABQoZpOsSG/wD/xAAYEAEBAAMAAAAAAAAAAAAAAAACAQADEP/aAAgBAQABBQLWas2GjgdGN1c//8QAFxEAAwEAAAAAAAAAAAAAAAAAARAREv/aAAgBAwEBPwEXS//EABYRAQEBAAAAAAAAAAAAAAAAAAEQIf/aAAgBAgEBPwFcn//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBEhMf/aAAgBAQAGPwLhTjC3H//EABkQAAMBAQEAAAAAAAAAAAAAAAABETFRYf/aAAgBAQABPyGqqy2jUHok7wlNo34f/9oADAMBAAIAAwAAABBPD//EABgRAAIDAAAAAAAAAAAAAAAAAAABESEx/9oACAEDAQE/EFWSws//xAAWEQEBAQAAAAAAAAAAAAAAAAABECH/2gAIAQIBAT8QIxP/xAAcEAEAAwEAAwEAAAAAAAAAAAABABEhMVFhgXH/2gAIAQEAAT8QdDtwGe/k1M0Dy8SyduH5L7hCnyPZqYqvhLXif//Z","aspectRatio":1.4970059880239521,"src":"/static/66cfd3beed4a6149c344fc6008978c94/a7715/setting-encrypted-backup-email-server.jpg","srcSet":"/static/66cfd3beed4a6149c344fc6008978c94/8f7df/setting-encrypted-backup-email-server.jpg 250w,\n/static/66cfd3beed4a6149c344fc6008978c94/0f3a1/setting-encrypted-backup-email-server.jpg 500w,\n/static/66cfd3beed4a6149c344fc6008978c94/a7715/setting-encrypted-backup-email-server.jpg 1000w,\n/static/66cfd3beed4a6149c344fc6008978c94/16310/setting-encrypted-backup-email-server.jpg 1024w","srcWebp":"/static/66cfd3beed4a6149c344fc6008978c94/e30b5/setting-encrypted-backup-email-server.webp","srcSetWebp":"/static/66cfd3beed4a6149c344fc6008978c94/7ca0e/setting-encrypted-backup-email-server.webp 250w,\n/static/66cfd3beed4a6149c344fc6008978c94/e9589/setting-encrypted-backup-email-server.webp 500w,\n/static/66cfd3beed4a6149c344fc6008978c94/e30b5/setting-encrypted-backup-email-server.webp 1000w,\n/static/66cfd3beed4a6149c344fc6008978c94/cc834/setting-encrypted-backup-email-server.webp 1024w","sizes":"(max-width: 1000px) 100vw, 1000px"}}},"path":"/blog/setting-encrypted-backup-email-server/","author":"Igor Rzegocki"}}},"pageContext":{}}}