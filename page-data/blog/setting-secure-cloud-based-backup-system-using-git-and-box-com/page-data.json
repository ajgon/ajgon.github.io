{"componentChunkName":"component---src-templates-blog-post-js","path":"/blog/setting-secure-cloud-based-backup-system-using-git-and-box-com/","result":{"data":{"allFile":{"edges":[{"node":{"publicURL":"/static/browserconfig-09e19ac7a78d68293c22953898762a5f.xml"}}]},"site":{"siteMetadata":{"siteUrl":"https://www.rzegocki.pl"}},"allMenuJson":{"edges":[{"node":{"id":"2e6028ce-fad1-487b-bace-6117f33e393f","name":"About","to":"about"}},{"node":{"id":"27dd36a1-f8af-4d43-8bab-c37310058c1e","name":"Technologies","to":"technologies"}},{"node":{"id":"447e8185-ac1a-42bc-a28c-4bc90e52735a","name":"Blog","to":"blog"}},{"node":{"id":"a9fc4afa-7b78-44d2-b015-4dac2ac2afe8","name":"Contact","to":"contact"}}]},"allShareJson":{"edges":[{"node":{"id":"2f0a723b-2772-40bf-9edc-70dd70337f10","slug":"facebook","name":"Facebook","url":"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup","width":626,"height":457}},{"node":{"id":"f5678f7f-ae05-444a-af1a-1167a30d0cce","slug":"linkedin","name":"LinkedIn","url":"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=","width":600,"height":450}},{"node":{"id":"4cbf0a18-d389-4583-98ac-501e59f1be18","slug":"twitter","name":"Twitter","url":"https://twitter.com/share?url=%POSTURL%&amp;text=","width":500,"height":550}}]},"markdownRemark":{"html":"<p>After giving up my <a href=\"https://www.google.com/intl/en-GB/gmail/about/\">spying e-mail provider</a>, and moving\neverything to my own <a href=\"https://github.com/ajgon/DeeDee\">DeeDee server</a>, I moved\nsmoothly from one paranoia to another. Ok, my e-mail is not read anymore by\nanyone except me, but on the other hand it's on an ATOM machine staying in my\nroom. Which unfortunatelly, is not fire, burglar, lightning and UFO protected.\nSo idea of backups was born. Firstly, I was using an external drive, which I\nwas keeping in the same room, most of the time even attached to the machine.\nBut I thought, that it is still\n<a href=\"https://www.youtube.com/watch?v=U4oB28ksiIo#t=286s\">not a best solution</a>. So I\nstarted swinging in the clouds.</p>\n<!--more-->\n<p>And immediately faced some problems:</p>\n<ul>\n<li>They are expensive, and free solutions have very limited capacity,</li>\n<li>They are external service, so distrust paranoia is getting back (in my case\nat least :))</li>\n<li>Most of them doesn't have any \"normal\" protocol to handle files, and they are\nbasing on a web interface and they \"one and only true\" client</li>\n</ul>\n<p>All of those three problems are unacceptable and needed to be solved if I\nwanted to even think about clouds.</p>\n<p>So I did some research, and found <a href=\"https://www.box.com/\">box.com</a> - in my\nopinion, the best solution out there. Why? Because it solves cases one and\nthree for me. It offers 50GB of storage (ALOT more than I need, all my emails\nand server-related files are approx. 8GB summarized), and they are supporting\nWebDAV protocol. Which means that fuse and davfs comes to play. The second\nproblem is actually pretty easy to solve as well - just use encryption\n(I use GPG).</p>\n<p>The next thing was snapshots. They had to be diff-based - that for sure. At the\nbeginning I tried to use rsync. It was nightmare. Sure, it had this\n<code class=\"language-text\">compare-dest</code> option, and after many hours of VooDoo magic I was able to set\nit properly, but still I was unhappy with it. Mostly, because it didn't handle\nfile removal very well (if some files were removed in a new snapshot, they\nsimply weren't included, so I didn't have any information about that, so when I\nrestore the backup, I will have all the files in a newest versions - removed as\nwell). And then it hit me - why not use some VCS? After 0.2 seconds of\nwondering, I chose git, because I love it. The next question is -  how to put\nall of this together?</p>\n<h2>Setting davfs for box.com</h2>\n<p>This step is pretty simple, just install it, add your box.com credentials to\n<code class=\"language-text\">/etc/davfs2/secrets</code>, set <code class=\"language-text\">use_locks</code> to <code class=\"language-text\">0</code> and add proper line to\n<code class=\"language-text\">/etc/fstab</code>. Then just mount it. So:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"https://www.box.com/dav    login@email.com     my_box_com_password\"</span> <span class=\"token operator\">>></span> /etc/davfs2/secrets\n<span class=\"token function\">sed</span> -i<span class=\"token string\">''</span> -r <span class=\"token string\">'s/#?\\s*use_locks\\s+0/use_locks 1/g'</span> /etc/davfs2/davfs2.conf\n<span class=\"token function\">mkdir</span> /mnt/Box\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"https://www.box.com/dav /mnt/Box davfs rw,noauto 0 0\"</span> <span class=\"token operator\">>></span> /etc/fstab\n<span class=\"token function\">mount</span> /mnt/Box</code></pre></div>\n<p>If everything went smooth, you will have access to your box.com account via\nfilesystem. Pretty neat.</p>\n<h2>Setting git-based backup</h2>\n<p>Firstly you need to set initial repository and backup files. Then encrypt them\nand copy to box.com. Here is how I do it:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token builtin class-name\">cd</span> /\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">MACHINE</span><span class=\"token operator\">=</span>DeeDee\n<span class=\"token function\">mkdir</span> -p /home/Backup/<span class=\"token variable\">${MACHINE}</span>\n<span class=\"token function\">mkdir</span> -p /mnt/Box/Backups/patches\n<span class=\"token function\">ln</span> -s /home/Backup/<span class=\"token variable\">${MACHINE}</span> /.git\n<span class=\"token function\">git</span> init\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> -A etc root home some/other/important/dirs\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">\"Initial\"</span>\n<span class=\"token function\">git</span> gc <span class=\"token comment\"># compress repository</span>\n<span class=\"token function\">tar</span> -cf /home/Backup/<span class=\"token variable\">${MACHINE}</span>.initial.tar /home/Backup/<span class=\"token variable\">${MACHINE}</span>/*\ngpg -e -r my.key@email.com /home/Backup/<span class=\"token variable\">${MACHINE}</span>.initial.tar\n<span class=\"token comment\"># box.com has maximum file limit so split files to lesser chunks</span>\n<span class=\"token function\">split</span> --bytes<span class=\"token operator\">=</span>99m /home/Backup/<span class=\"token variable\">${MACHINE}</span>.initial.tar.gpg /home/Backup/<span class=\"token variable\">${MACHINE}</span>.initial.tar.\n<span class=\"token function\">mv</span> /home/Backup/DeeDee.<span class=\"token variable\">${MACHINE}</span>.tar.?? /mnt/Box/Backups</code></pre></div>\n<p>If you have alot of files, some of them may not be copied in a first time - in\nthis initial deploy, make sure that all the files are moved to box.com!</p>\n<p>After that all we need is a daily-snapshot deploy script</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NOW</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> -I<span class=\"token variable\">`</span></span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">MACHINE</span><span class=\"token operator\">=</span>DeeDee\n<span class=\"token builtin class-name\">cd</span> /\n<span class=\"token function\">git</span> <span class=\"token function\">add</span> -A\n<span class=\"token function\">git</span> commit -m <span class=\"token string\">\"<span class=\"token variable\">${NOW}</span>\"</span> -a\n<span class=\"token function\">git</span> format-patch -1 --stdout <span class=\"token operator\">></span> /home/Backup/<span class=\"token variable\">${MACHINE}</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">${NOW}</span>.patch\ngpg -e -r your@key.email /home/Backup/<span class=\"token variable\">${MACHINE}</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">${NOW}</span>.patch\n<span class=\"token function\">split</span> --bytes<span class=\"token operator\">=</span>50m /home/Backup/<span class=\"token variable\">${MACHINE}</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">${NOW}</span>.patch.gpg /home/Backup/<span class=\"token variable\">${MACHINE}</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">${NOW}</span>.patch.\n<span class=\"token function\">mv</span> /home/Backup/<span class=\"token variable\">${MACHINE}</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">${NOW}</span>.patch.?? /mnt/Box/Backups/patches</code></pre></div>\n<p>Now all you need to do is put this script to some file, and add it to cron:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token number\">0</span> <span class=\"token number\">3</span> * * * /backup</code></pre></div>\n<h2>Restoring backup</h2>\n<p>This is pretty simple. First, fetch all the <code class=\"language-text\">*.initial.*</code> files to some\ndirectory, then merge them, decrypt and unpack.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token function\">mkdir</span> -p /home/Restore/.git\n<span class=\"token builtin class-name\">cd</span> /home/Restore/.git\n<span class=\"token function\">cp</span> /mnt/Box/Backups/*.initial.* <span class=\"token builtin class-name\">.</span>\n<span class=\"token function\">cat</span> *.initial.* <span class=\"token operator\">></span> Backup.initial.tar\n<span class=\"token function\">tar</span> -xf Backup.initial.tar\n<span class=\"token function\">rm</span> -rf Backup.initial.tar</code></pre></div>\n<p>Now you need to apply the patches:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span><span data-user=root data-host=localhost></span></span><span class=\"token builtin class-name\">cd</span> /home/Restore\n<span class=\"token function\">cp</span> /mnt/Box/Backups/patches/* <span class=\"token builtin class-name\">.</span>\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> *.patch.aa<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token function\">mv</span> <span class=\"token variable\">${i}</span> <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">echo</span> $<span class=\"token punctuation\">{</span>i<span class=\"token punctuation\">}</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> -r <span class=\"token string\">'s/.aa$//'</span><span class=\"token variable\">`</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span>\n<span class=\"token comment\"># Don't forget to concatenate splitted patches, so for example:</span>\n<span class=\"token function\">cat</span> Backup.2012-10-14.patch.* <span class=\"token operator\">></span> Backup.2012-10.14.patch\n<span class=\"token function\">git</span> apply *.patch</code></pre></div>\n<p>And the last thing is simply to restore repo to it's current state:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"command-line-prompt\"><span data-user=root data-host=localhost></span></span><span class=\"token function\">git</span> reset --hard master</code></pre></div>\n<p>And voilla, everything is back!</p>\n<h2>Conclusion</h2>\n<p>Is simple... I sincerely hope, that you will have better sleep with this\nsolution applied. I have :). And if not, you can always extend it to another\ngood-space, webdav supporting clouds. I didn't find anything as good as\nbox.com, but if you do - please, let me know!</p>","excerpt":"After giving up my spying e-mail provider, and moving\neverything to my own DeeDee server, I moved\nsmoothly from one paranoia to another. Ok…","frontmatter":{"id":"86585931-0df6-43eb-bf25-e41387b5adf4","title":"Setting secure, cloud-based backup system using git and box.com","date":"October 14, 2012","isoDate":"2012-10-14T10:57:00.000Z","cover":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAv/EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAV6TUhJMTv8A/8QAHBAAAgICAwAAAAAAAAAAAAAAAQIAAxESITEy/9oACAEBAAEFAhYxmxJZuU6wJZ6//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAECEf/aAAgBAwEBPwElLD//xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAIAQIBAT8BuK//xAAcEAABAwUAAAAAAAAAAAAAAAABAAIREiAhYZH/2gAIAQEABj8Cio9UrLiNCz//xAAbEAEAAgIDAAAAAAAAAAAAAAABACERQTFxsf/aAAgBAQABPyEcXYKYBlmstznNuyEwqWFTzn//2gAMAwEAAgADAAAAEGPv/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAR/9oACAEDAQE/EDZQ0L//xAAXEQEBAQEAAAAAAAAAAAAAAAABABEh/9oACAECAQE/EHSVvG//xAAbEAACAwEBAQAAAAAAAAAAAAABEQAhcTGBwf/aAAgBAQABPxBPLRUHG47M8zRoO4CoRsADyHHIGxFLDg+Qb4n/2Q==","aspectRatio":1.7996485061511422,"src":"/static/01fd14d0de673b476ad8c6bdcffea2a5/2f7e7/setting-secure-cloud-based-backup-system-using-git-and-box-com.jpg","srcSet":"/static/01fd14d0de673b476ad8c6bdcffea2a5/4d406/setting-secure-cloud-based-backup-system-using-git-and-box-com.jpg 250w,\n/static/01fd14d0de673b476ad8c6bdcffea2a5/32ee9/setting-secure-cloud-based-backup-system-using-git-and-box-com.jpg 500w,\n/static/01fd14d0de673b476ad8c6bdcffea2a5/2f7e7/setting-secure-cloud-based-backup-system-using-git-and-box-com.jpg 1000w,\n/static/01fd14d0de673b476ad8c6bdcffea2a5/426ce/setting-secure-cloud-based-backup-system-using-git-and-box-com.jpg 1024w","sizes":"(max-width: 1000px) 100vw, 1000px"}}},"path":"/blog/setting-secure-cloud-based-backup-system-using-git-and-box-com/","author":"Igor Rzegocki"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}