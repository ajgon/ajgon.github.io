webpackJsonp([0x89c23ae607a7],{506:function(e,n){e.exports={data:{allShareJson:{edges:[{node:{id:"2f0a723b-2772-40bf-9edc-70dd70337f10",slug:"facebook",name:"Facebook",url:"https://www.facebook.com/sharer/sharer.php?u=%POSTURL%;display=popup",width:626,height:457}},{node:{id:"f5678f7f-ae05-444a-af1a-1167a30d0cce",slug:"linkedin",name:"LinkedIn",url:"https://www.linkedin.com/shareArticle?mini=true&amp;url=%POSTURL%&amp;title=",width:600,height:450}},{node:{id:"4cbf0a18-d389-4583-98ac-501e59f1be18",slug:"twitter",name:"Twitter",url:"https://twitter.com/share?url=%POSTURL%&amp;text=",width:500,height:550}}]},markdownRemark:{html:'<p>While developing my <a href="https://www.github.com/wombatapp">new replacement</a> of <a href="https://github.com/ajgon/self-hosted-mailserver">self-hosted-mailserver</a>,\nI noticed a funny problem - I couldn\'t make gnupg2 to work\nwith docker non-interactively. At first, the problem was with an import:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">$ gpg --import <span class="token string">"/tmp/private.key"</span>\nStep 1/4 <span class="token keyword">:</span> FROM alpine\n ---<span class="token operator">></span> 4a415e366388\nStep 2/4 <span class="token keyword">:</span> RUN apk add --no-cache <span class="token function">wget</span> gnupg\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 724679f224aa\nStep 3/4 <span class="token keyword">:</span> ADD private.key /tmp/\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 49c8b89aecc7\nStep 4/4 <span class="token keyword">:</span> RUN gpg --import /tmp/private.key\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 9a45499d851f\ngpg: directory <span class="token string">\'/root/.gnupg\'</span> created\ngpg: new configuration <span class="token function">file</span> <span class="token string">\'/root/.gnupg/dirmngr.conf\'</span> created\ngpg: new configuration <span class="token function">file</span> <span class="token string">\'/root/.gnupg/gpg.conf\'</span> created\ngpg: keybox <span class="token string">\'/root/.gnupg/pubring.kbx\'</span> created\ngpg: /root/.gnupg/trustdb.gpg: trustdb created\ngpg: key A7AD7E10789C6F1E: public key <span class="token string">"testete &lt;test@example.com>"</span> imported\ngpg: key A7AD7E10789C6F1E/F7886F60959E549E: error sending to agent: Not a <span class="token function">tty</span>\ngpg: Total number processed: 1\ngpg:               imported: 1\ngpg:       secret keys read: 1\nThe <span class="token function">command</span> <span class="token string">\'/bin/sh -c gpg --import /tmp/private.key\'</span> returned a non-zero code: 2</code></pre>\n      </div>\n<p>You may notice <code class="language-text">error sending to agent: Not a tty</code> error. This one was actually easy, there is <code class="language-text">--batch</code> parameter\nwhich forces gnupg2 to work in non-interactive mode:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">$ gpg --batch --import <span class="token string">"/tmp/private.key"</span>\nStep 1/4 <span class="token keyword">:</span> FROM alpine\n ---<span class="token operator">></span> 4a415e366388\nStep 2/4 <span class="token keyword">:</span> RUN apk add --no-cache <span class="token function">wget</span> gnupg\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 724679f224aa\nStep 3/4 <span class="token keyword">:</span> ADD private.key /tmp/\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 49c8b89aecc7\nStep 4/4 <span class="token keyword">:</span> RUN gpg --batch --import /tmp/private.key\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 986fd9ae42c0\ngpg: directory <span class="token string">\'/root/.gnupg\'</span> created\ngpg: new configuration <span class="token function">file</span> <span class="token string">\'/root/.gnupg/dirmngr.conf\'</span> created\ngpg: new configuration <span class="token function">file</span> <span class="token string">\'/root/.gnupg/gpg.conf\'</span> created\ngpg: keybox <span class="token string">\'/root/.gnupg/pubring.kbx\'</span> created\ngpg: /root/.gnupg/trustdb.gpg: trustdb created\ngpg: key A7AD7E10789C6F1E: public key <span class="token string">"testete &lt;test@example.com>"</span> imported\ngpg: key A7AD7E10789C6F1E: secret key imported\ngpg: Total number processed: 1\ngpg:               imported: 1\ngpg:       secret keys read: 1\ngpg:   secret keys imported: 1\n ---<span class="token operator">></span> ba9639723f2c\nRemoving intermediate container 986fd9ae42c0\nSuccessfully built ba9639723f2c</code></pre>\n      </div>\n<p>But the bigger problem arrives, when we try to decrypt something with a password protected key\n(to make codeblocks readable, I will only paste things which changed):</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">$ gpg -r test@example.com -d <span class="token string">"/tmp/file.gpg"</span> <span class="token operator">></span> <span class="token string">"/tmp/file"</span>\nStep 5/6 <span class="token keyword">:</span> ADD file.gpg /tmp/\n ---<span class="token operator">></span> 434115276622\nRemoving intermediate container 0ee978044580\nStep 6/6 <span class="token keyword">:</span> RUN gpg -r test@example.com -d /tmp/file.gpg <span class="token operator">></span> /tmp/file\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> a254a182e0f0\ngpg: encrypted with 2048-bit RSA key, ID F7886F60959E549E, created 2017-04-03\n      <span class="token string">"testete &lt;test@example.com>"</span>\ngpg: public key decryption failed: Not a <span class="token function">tty</span>\ngpg: decryption failed: No secret key\nThe <span class="token function">command</span> <span class="token string">\'/bin/sh -c gpg -r test@example.com -d /tmp/file.gpg > /tmp/file\'</span> returned a non-zero code: 2</code></pre>\n      </div>\n<p>Well, the most obvious thing to do is to add <code class="language-text">--batch</code> again and hope this helps:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">$ gpg --batch -r test@example.com -d <span class="token string">"/tmp/file.gpg"</span> <span class="token operator">></span> <span class="token string">"/tmp/file"</span>\nStep 6/6 <span class="token keyword">:</span> RUN gpg --batch -r test@example.com -d /tmp/file.gpg <span class="token operator">></span> /tmp/file\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 66de260f1bf4\ngpg: encrypted with 2048-bit RSA key, ID F7886F60959E549E, created 2017-04-03\n      <span class="token string">"testete &lt;test@example.com>"</span>\ngpg: public key decryption failed: Not a <span class="token function">tty</span>\ngpg: decryption failed: No secret key\nThe <span class="token function">command</span> <span class="token string">\'/bin/sh -c gpg --batch -r test@example.com -d /tmp/file.gpg > /tmp/file\'</span> returned a non-zero code: 2</code></pre>\n      </div>\n<p>Still the same error! But why? Wasn\'t <code class="language-text">--batch</code> supposed to run gnupg2 in non-interactive mode? Well,\nactually it was, and it did. But still it didn\'t know a password - I needed some way to pass it through. Thankfully,\ngnupg2 supports an <code class="language-text">PASSPHRASE</code> environmental variable:</p>\n<div class="gatsby-highlight" data-language="text">\n      <pre class="language-text"><code class="language-text">$ PASSPHRASE=&quot;key-password&quot; gpg --batch -r test@example.com -d &quot;/tmp/file.gpg&quot; &gt; &quot;/tmp/file&quot;\nStep 6/7 : ENV PASSPHRASE key-password\n ---&gt; Running in 306b5791abcb\n ---&gt; 0a3bc0bc1d76\nRemoving intermediate container 306b5791abcb\nStep 7/7 : RUN gpg --batch -r test@example.com -d /tmp/file.gpg &gt; /tmp/file\n ---&gt; Running in 9311634f162b\ngpg: encrypted with 2048-bit RSA key, ID F7886F60959E549E, created 2017-04-03\n      &quot;testete &lt;test@example.com&gt;&quot;\ngpg: public key decryption failed: Not a tty\ngpg: decryption failed: No secret key\nThe command &#39;/bin/sh -c gpg --batch -r test@example.com -d /tmp/file.gpg &gt; /tmp/file&#39; returned a non-zero code: 2</code></pre>\n      </div>\n<p>At this point I was puzzled - clearly something was still missing. There is a <code class="language-text">GPG_TTY</code> env variable, but it won\'t\nhelp much - passing it to a terminal when we can\'t provide user input does not bode well for success. And then it\nhit me: it\'s not a gnupg2 which asks for a password - it\'s the pinentry application handled by the <code class="language-text">gpg-agent</code> which\nkicks in in a process. Unfortunately disabling a <code class="language-text">gpg-agent</code> was not an option, as it\'s tightly integrated into\ngnupg2 for some reason. Another possible thing was replacing the pinentry program to something else - but it was also\ndead end. Every <code class="language-text">pinetry</code> program which I found, required me to entry the password at some point.</p>\n<p>Finally, after hours of googling and ripping my last hairs out, I found some post which was describing a\n<code class="language-text">--pinentry-mode loopback</code> option for gnupg2. Basically what it does, it wires password entering back to gnupg2.\nUnfortunatelly it still needs to be provided (<code class="language-text">PASSPHRASE</code> didn\'t work), but I felt I was close.</p>\n<p>And it happened to be true. There is another parameter to gnupg2 <code class="language-text">--command-fd</code> which expects a list of commands,\npassed via given input. The input is identified by the number, so <code class="language-text">--command-fd 0</code> meant STDIN. All which was left,\nwas passing the password AGAIN, this time via the pipe.</p>\n<p>Eventually I ended up with this nice, and simple command:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token keyword">echo</span> <span class="token string">"key-password"</span> <span class="token operator">|</span> PASSPHRASE<span class="token operator">=</span><span class="token string">"key-password"</span> gpg --batch \\\n--pinentry-mode loopback --command-fd 0 -r test@example.com \\\n-d /tmp/file.gpg <span class="token operator">></span> /tmp/file</code></pre>\n      </div>\n<p>And voilla! It worked!</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash">$ <span class="token keyword">echo</span> <span class="token string">"key-password"</span> <span class="token operator">|</span> PASSPHRASE<span class="token operator">=</span><span class="token string">"key-password"</span> gpg --batch --pinentry-mode loopback --command-fd 0 -r test@example.com -d <span class="token string">"/tmp/file.gpg"</span> <span class="token operator">></span> <span class="token string">"/tmp/file"</span>\nStep 6/8 <span class="token keyword">:</span> ENV PASSPHRASE key-password\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 0a3bc0bc1d76\nStep 7/8 <span class="token keyword">:</span> RUN <span class="token keyword">echo</span> <span class="token string">"key-password"</span> <span class="token operator">|</span> gpg --batch --pinentry-mode loopback --command-fd 0 -r test@example.com -d /tmp/file.gpg <span class="token operator">></span> /tmp/file\n ---<span class="token operator">></span> Using cache\n ---<span class="token operator">></span> 0b7caaabda65\nStep 8/8 <span class="token keyword">:</span> RUN <span class="token function">cat</span> /tmp/file\n ---<span class="token operator">></span> Running <span class="token keyword">in</span> 598331a9ea4e\n<span class="token function">test</span>\n ---<span class="token operator">></span> d14ea6fe5958\nRemoving intermediate container 598331a9ea4e\nSuccessfully built d14ea6fe5958</code></pre>\n      </div>\n<p>The drawback is that those switches were introduced in GPG 2.1, so you\'re going to need a fairly fresh version of\nthe app. But hey! We\'re talking cryptography here - you SHOULD use the most recent software available!</p>\n<p>P.S. As a bonus, here is the full command for duplicity, for those folks, who want to build encrypted backups\nin Docker containers:</p>\n<div class="gatsby-highlight" data-language="bash">\n      <pre class="language-bash"><code class="language-bash"><span class="token keyword">echo</span> <span class="token string">"key-password"</span> <span class="token operator">|</span> PASSPHRASE<span class="token operator">=</span><span class="token string">"key-password"</span> duplicity \\\n--gpg-options <span class="token string">"--pinentry-mode loopback --command-fd 0"</span> \\\n--encrypt-key <span class="token string">"KEY-ID"</span> /backup/source protocol://host/backup/destination</code></pre>\n      </div>',excerpt:"While developing my  new replacement  of  self-hosted-mailserver ,\nI noticed a funny problem - I couldn't make gnupg2 to work\nwith dockerâ€¦",frontmatter:{title:"How to make gnupg2 to fall in love with Docker",date:"April 03, 2017",cover:{childImageSharp:{sizes:{base64:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsSAAALEgHS3X78AAACgklEQVQoz6VSW0tUURT+9pkbM+qMZ3TOOTOJkmiOUmppdKMYpTJCEVJiMrB8KMqiJEvJJB/EIGMoRDQfBsuZOXOOM3Mcx+ximEk+RNmNqEjC0C4QQf4E20frwctD0OJ7WOy1vvXt9e0NicMqEIjIwm+C3wiayHZG4snKttWYPAmYoWSzj6t3jdcUR/P4QAL+jUw1LRh2OT/Gbsw8V2ZfxKZHex+WFdBxssCsTg5SNbtWFDSSTRV5e+vKzOTQ9ITyabz/6+v7M8Pd4TRDMFktiTyzgsyRAQtCHCNaoeQkTT2SPk/e+zJ599e70bn3Yz9fxoa3pPotEB062UabQWWo3gLZBnmNvqWkrCsrJWSF5NBOxXq+fXgy++yO1Nna1d78fUIOZ5plFhEr6cjgREGrWBC2Qp0xaMaZ0sNVlbV7K87RgpyAMbfLXbn/iLv8cv3xTXnZr+rckhG37YYDFQd31NT2OuJatxV2ZqrbMuFElJy4Vld/takjJDkFL4uGeIYn5Jir4ObZarPJWBGn8dp1209e5DyhjDbv1ob2otqmtvVrIfPoY/Fm5MHc/PyFpz+uZ6YGrDhq1gCk2MDs1oJGvYUEOFJ6qjHXN0Y8sbTzHk+6EGGhbk89GC/fGTxU2eza43UYBzm0sNATbNRjn4kxMcTPkUgSoqmmnqLCS/nOPt4QteKvYRx8ZgQToCSq5oV4dCfDRJCuQ1U8cvSI8hCpwzbSb8GAdfHB1D+DAKeC2ibatX5BS3M/hwiP02aUGNHGYrMBCg+f2kb8gsbHM/QiiywM8ssxwGNEUGmNiejnsEGPPhuGFs6jS4F8/XLQ7lw9UjRI0yJLBwP5k6zTwbkU/xW/AawM8NR3aso5AAAAAElFTkSuQmCC",aspectRatio:1.3333333333333333,src:"/static/how-to-make-gnupg2-to-fall-in-love-with-docker-5ac8051d451821323f3575d470e2fa8d-8cfe2.png",srcSet:"/static/how-to-make-gnupg2-to-fall-in-love-with-docker-5ac8051d451821323f3575d470e2fa8d-130b9.png 250w,\n/static/how-to-make-gnupg2-to-fall-in-love-with-docker-5ac8051d451821323f3575d470e2fa8d-489bc.png 500w,\n/static/how-to-make-gnupg2-to-fall-in-love-with-docker-5ac8051d451821323f3575d470e2fa8d-8cfe2.png 1000w,\n/static/how-to-make-gnupg2-to-fall-in-love-with-docker-5ac8051d451821323f3575d470e2fa8d-eb1d2.png 1024w",sizes:"(max-width: 1000px) 100vw, 1000px"}}},path:"/blog/how-to-make-gnupg2-to-fall-in-love-with-docker",author:"Igor Rzegocki"}}},pathContext:{}}}});
//# sourceMappingURL=path---blog-how-to-make-gnupg-2-to-fall-in-love-with-docker-0d276861cff931cb3cd9.js.map